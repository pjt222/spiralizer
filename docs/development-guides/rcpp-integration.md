# Rcpp Integration Guide

This guide covers best practices for integrating C++ code via Rcpp in R packages.

## Package Setup

### DESCRIPTION Configuration

```yaml
Suggests:
    Rcpp           # Optional dependency
LinkingTo:
    Rcpp           # Required for compilation
```

Using `Suggests` instead of `Imports` makes Rcpp optional - the package works without compiled code.

### NAMESPACE Configuration

```r
# Enable dynamic library loading
useDynLib(spiralizer, .registration = TRUE)

# Export Rcpp functions (optional)
export(generate_spiral_cpp)
export(calculate_limits_cpp)
```

## Source File Structure

### C++ Source Location

Place C++ files in `src/`:

```
src/
  spiral_rcpp.cpp    # Your C++ code
  RcppExports.cpp    # Auto-generated by Rcpp
```

### RcppExports Files

Roxygen2 generates these automatically:
- `src/RcppExports.cpp` - C++ registration code
- `R/RcppExports.R` - R wrapper functions

Add `RcppExports.R` to the `Collate` field:

```yaml
Collate:
    'aaa-utils.R'
    'RcppExports.R'    # Generated Rcpp wrappers
    'constants.R'
    ...
```

## Conditional Rcpp Usage

### Graceful Fallback Pattern

Make Rcpp functions optional with R fallbacks:

```r
#' Generate Fermat Spiral Points
#'
#' Uses C++ implementation if available, falls back to R.
#' @export
generate_fermat_spiral <- function(angle_start, angle_end, num_points) {
  # Try C++ version first
  if (exists("generate_spiral_cpp", mode = "function")) {
    tryCatch(
      return(generate_spiral_cpp(angle_start, angle_end, num_points)),
      error = function(e) NULL
    )
  }

  # Fallback to R implementation
  generate_fermat_spiral_r(angle_start, angle_end, num_points)
}

#' Pure R Implementation (Internal)
#' @keywords internal
generate_fermat_spiral_r <- function(angle_start, angle_end, num_points) {
  theta <- seq(angle_start, angle_end, length.out = num_points)
  r <- sqrt(theta)
  x <- r * cos(theta)
  y <- r * sin(theta)
  cbind(x = x, y = y)
}
```

### Checking Rcpp Availability

```r
# In .onLoad or runtime
rcpp_available <- function() {
  exists("generate_spiral_cpp", mode = "function") &&
    is.function(get("generate_spiral_cpp"))
}
```

## C++ Code Patterns

### Basic Rcpp Function

```cpp
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
NumericMatrix generate_spiral_cpp(
    double angle_start,
    double angle_end,
    int num_points
) {
  NumericVector theta = seq(angle_start, angle_end, num_points);
  NumericMatrix result(num_points, 2);

  for (int i = 0; i < num_points; i++) {
    double r = sqrt(theta[i]);
    result(i, 0) = r * cos(theta[i]);
    result(i, 1) = r * sin(theta[i]);
  }

  colnames(result) = CharacterVector::create("x", "y");
  return result;
}
```

### Performance Tips

1. **Avoid R object creation in loops** - pre-allocate
2. **Use references** for large objects: `const NumericVector& x`
3. **Consider RcppArmadillo** for matrix operations
4. **Profile before optimizing** - R may be fast enough

## R CMD check Notes

### Expected NOTE for Conditional Functions

When using conditional Rcpp, R CMD check shows:

```
NOTE: no visible global function definition for 'generate_spiral_cpp'
```

This is expected and harmless when:
- The function is conditionally available
- Fallback code handles the missing function
- The package works without Rcpp compiled

### Suppressing the NOTE

If desired, declare the function exists (though it may not):

```r
# At package level, if you want to suppress the NOTE
if (FALSE) {
  generate_spiral_cpp <- function(...) NULL
}
```

## Compilation Troubleshooting

### Common Issues

| Problem | Solution |
|---------|----------|
| Rtools not found | Install Rtools, add to PATH |
| Rcpp not installed | `install.packages("Rcpp")` |
| Compilation errors | Check C++ syntax, includes |
| Linking errors | Check `useDynLib` in NAMESPACE |

### Windows-Specific

Ensure Rtools is properly installed and in PATH:

```r
# Check Rtools
Sys.which("g++")
pkgbuild::has_build_tools()
```

## Performance Comparison

Typical speedups for vectorized operations:

| Operation | R Time | Rcpp Time | Speedup |
|-----------|--------|-----------|---------|
| Spiral generation (10K pts) | 50ms | 5ms | 10x |
| Limit calculation | 20ms | 2ms | 10x |
| Complex math loops | 100ms | 8ms | 12x |

Note: Simple vectorized R code may not benefit significantly from Rcpp.

## Summary

1. Use `Suggests` for optional Rcpp dependency
2. Always provide R fallback implementations
3. Check function existence before calling Rcpp code
4. Add `RcppExports.R` to Collate field
5. The "undefined function" NOTE is expected for conditional usage
